# 青武jam
Webサイト総合技術解説
<small>(ドキュメント・ソースコード準拠)</small>

---

### アーキテクチャ & 認証
ASP.NET Core MVCパターンを基本とし、リアルタイム通信部分をFirebaseが担います。

**認証フロー:**
- **匿名認証 (一般ユーザー):** 掲示板投稿など、登録不要の機能で使用。
- **メール/パスワード認証 (管理者):** 丼カウンター更新など、特権が必要な操作で使用 (`admin@seibu.local`)。

---

### 中核サービス: FirebaseService.cs
Firebase Realtime Databaseとの全ての通信をカプセル化する重要なサービスです。
- **責務:** データベースへのCRUD操作、認証トークン管理、入力値の検証とサニタイズ。
- **XSS対策:** ユーザー入力は `System.Net.WebUtility.HtmlEncode` を用いてHTMLエンコードし、安全性を確保します。

---

## ホーム & 掲示板
天気予報、風呂の混雑度予測、掲示板機能を提供するメインページ。

---

### 技術詳細: ホーム & 掲示板
**バックエンド (`HomeController`, `FirebaseController`):**
ページの初期表示と、掲示板への投稿リクエストを処理します。

**データ永続化 (`FirebaseService`):**
Firebaseとの通信を担い、メッセージの投稿や取得を行います。投稿は匿名認証、メッセージ削除は管理者認証が必要です。

**フロントエンド (`Home/Index.cshtml`):**
- **天気:** 気象庁APIを非同期で取得し表示します。
- **混雑度（予測）:** Chart.jsを使い、曜日や天候を考慮した予測グラフを動的に描画します。
- **混雑度（現在）:** Firebase Realtime Databaseから現在のスリッパ数と混雑度を取得し、リアルタイムに表示します。30秒間隔で自動更新され、手動更新も可能です。
- **掲示板:** ユーザー操作をトリガーに非同期でデータを送受信し、UIに反映します。

---

## 丼カウンター
寮の昼食が「丼」だったかどうかを記録・集計するカウンターです。

---

### 技術詳細: 丼カウンター
**バックエンド (`DonCounterController`):**
カウンターの表示(GET)と、パスワード(`seibu2025`)で保護された更新/リセット(POST)を処理します。

**データ永続化 (`FirebaseService` & Rules):**
Firebaseのセキュリティルールにより、データの読み取りは全ユーザーに許可し、書き込みは管理者(`admin@seibu.local`)のみに制限しています。

**フロントエンド (`DonCounter/Index.cshtml`):**
サーバーから渡されたデータを基に、丼率/非丼率を計算し、Bootstrapのプログレスバーで視覚的に表示します。

---

## スケジュール
福井高専の年間行事予定を月別のタブとカレンダーで表示します。

---

### 技術詳細: スケジュール
**バックエンド (`HomeController.cs`):**
- `schedule`アクションは、静的な`Schedule.cshtml`ビューを返すシンプルな構成です。

**フロントエンド (`Schedule.cshtml` & `schedule-calendar.js`):**
- **行事データ:** `schedule-calendar.js`内の`ScheduleCalendar`クラスに、JavaScriptのオブジェクトとして全行事データがハードコードされています。
- **動的カレンダー生成:** ユーザーが月のタブを切り替えると、JavaScriptがその月のカレンダーを動的に生成・描画します。日付セルには、祝日、試験、イベントなどの種類に応じて異なるCSSクラスが付与され、色分けされます。
- **凡例表示:** 各月のカレンダー下部には、その月に存在する行事の種類だけの凡例が動的に生成され、ユーザービリティを高めています。

---

## デスカウントダウン
次の試験までの残り日数を表示する、刺激的なデザインのページです。

---

### 技術詳細: デスカウントダウン
**フロントエンド (`ExamCountdown.cshtml` & JS):**
- **試験データ:** JavaScriptの配列(`scheduleData`)として、試験期間のデータが静的に保持されています。
- **カウントダウンロジック:** `getJapanTime`関数で正確な日本時間を取得し、今日の日付と比較して次の試験開始日までの残り日数を計算します。
- **UI更新:** 計算結果を基に、メインのカウントダウン表示と、それ以降の試験予定リストを動的に更新します。
- **デザイン:** CSSで`Creepster`フォントや、`@keyframes`を用いたアニメーションを多用し、ページの世界観を演出しています。

---

## 鯖江駅時刻表
鯖江駅のハピラインふくい線の時刻をリアルタイムに表示します。

---

### 技術詳細: 鯖江駅時刻表
**バックエンド (`TrainScheduleController.cs`):**
- `Index`アクション内で、福井方面と敦賀方面の時刻表データを`List<TrainInfo>`としてハードコーディングし、Viewに渡しています。

**フロントエンド (`Index.cshtml` & JS):**
- **リアルタイム更新:** `setInterval`を使い、1秒ごとに現在時刻を更新します。
- **次の電車計算:** JavaScriptが現在時刻と全電車の発車時刻を比較し、次に出発する電車を特定します。
- **動的ハイライト:** 既に出発した電車には`passed-train`クラスを、次に出発する電車には`next-train`クラスを動的に付与し、CSSで見た目を変更しています。

---

## 現在の混雑度取得プログラム
寮の風呂の現在の混雑度をリアルタイムで表示する機能。

---

### 技術詳細: バックエンド
**バックエンド (`HomeController.cs`, `FirebaseService.cs`):**
- `HomeController`の`Index`アクションで`FirebaseService.GetCurrentBathCongestion()`を呼び出し、現在の混雑度データを取得します。
- `FirebaseService.GetCurrentBathCongestion()`は、Firebase Realtime Databaseの`bathCongestion/current`パスから最新の混雑度情報を取得します。
- `HomeController`には、Ajaxリクエストで最新の混雑度を取得するための`GetCurrentCongestion`APIエンドポイントも実装されています。

---

### 技術詳細: データモデル
**データモデル (`BathCongestion.cs`):**
- 混雑度情報を格納するためのモデルで、`SlippersCount`（スリッパ数）、`CongestionLevel`（混雑レベル）、`CongestionPercentage`（混雑度パーセンテージ）、`Message`（表示メッセージ）、`LastUpdated`（最終更新日時）などのプロパティを持ちます。
- **スリッパカウント:** 寮の風呂の混雑度を測るための主要な指標。風呂の入り口に置かれたスリッパの数をカウントし、その数をFirebaseに記録することで、現在の混雑状況を数値化しています。この数値は、混雑度パーセンテージやメッセージの算出にも利用されます。

---

### 技術詳細: フロントエンド
**フロントエンド (`Home/Index.cshtml` & JS):**
- 取得した混雑度データは、`Home/Index.cshtml`内で表示されます。
- JavaScriptにより、30秒間隔での自動更新と、手動での更新機能が提供されています。

---

### プログラム処理手順: スリッパカウントシステム
寮の風呂の混雑度をリアルタイムで把握するため、以下の手順でデータが処理されます。
- **1. 画像撮影 (`syori_2.py`):** 接続されたウェブカメラ（BUSID 2-9）からスリッパの画像を撮影し、一時ファイルとして保存します。
- **2. 画像解析 (`gemini_analyzer.py`):** 撮影された画像をGoogle Gemini APIに送信し、「画像に写っているスリッパの組数」を質問します。Gemini APIの利用には、複数のモデル（`gemini-2.0-flash-lite-001`, `gemini-2.0-flash`, `gemini-1.5-flash`）を優先順位付けして試行するフォールバックロジックが実装されており、APIクォータやエラー発生時にも対応します。
- **3. スリッパ数抽出と混雑度計算 (`firebase_updater.py`):** Gemini APIからの解析結果（テキスト）から正規表現を用いてスリッパの組数（数字）を抽出し、その数に基づいて寮の風呂の混雑度（「空いています」などのレベル、パーセンテージ、表示メッセージ）を計算します。
- **4. Firebaseへのデータ送信 (`firebase_updater.py`):** 計算された混雑度データは、Firebase Admin SDKを通じてFirebase Realtime Databaseに送信されます。現在の混雑度情報（`bathCongestion/current`）がリアルタイムで更新されるとともに、履歴データ（`bathCongestion/history`）としても記録されます。